name: CD - Deploy

run-name: "CD #${{ github.run_number }} - Deploy to ${{ inputs.environment || 'dev' }}"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: environment
      deploy_migrations:
        description: 'Deploy database migrations'
        required: true
        type: boolean
        default: true
      deploy_api:
        description: 'Deploy API'
        required: true
        type: boolean
        default: true
      deploy_jobs:
        description: 'Deploy Jobs'
        required: true
        type: boolean
        default: true
      deploy_web:
        description: 'Deploy Web'
        required: true
        type: boolean
        default: true
      build_cli:
        description: 'Build environment-specific CLI'
        required: true
        type: boolean
        default: false
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  DOTNET_VERSION: '9.0.x'

jobs:
  check-trigger:
    name: Check Deployment Trigger
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      environment: ${{ steps.check.outputs.environment }}
      deploy_migrations: ${{ steps.check.outputs.deploy_migrations }}
      deploy_api: ${{ steps.check.outputs.deploy_api }}
      deploy_jobs: ${{ steps.check.outputs.deploy_jobs }}
      deploy_web: ${{ steps.check.outputs.deploy_web }}
      build_cli: ${{ steps.check.outputs.build_cli }}
    steps:
      - name: Determine deployment parameters
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual deployment triggered"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "deploy_migrations=${{ inputs.deploy_migrations }}" >> $GITHUB_OUTPUT
            echo "deploy_api=${{ inputs.deploy_api }}" >> $GITHUB_OUTPUT
            echo "deploy_jobs=${{ inputs.deploy_jobs }}" >> $GITHUB_OUTPUT
            echo "deploy_web=${{ inputs.deploy_web }}" >> $GITHUB_OUTPUT
            echo "build_cli=${{ inputs.build_cli }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
              echo "Automatic deployment from successful CI on main"
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "environment=dev" >> $GITHUB_OUTPUT
              echo "deploy_migrations=true" >> $GITHUB_OUTPUT
              echo "deploy_api=true" >> $GITHUB_OUTPUT
              echo "deploy_jobs=true" >> $GITHUB_OUTPUT
              echo "deploy_web=true" >> $GITHUB_OUTPUT
              echo "build_cli=false" >> $GITHUB_OUTPUT
            else
              echo "CI workflow did not succeed, skipping deployment"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Unknown trigger, skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy-migrations:
    name: Deploy Database Migrations
    needs: check-trigger
    if: needs.check-trigger.outputs.should_deploy == 'true' && needs.check-trigger.outputs.deploy_migrations == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy and Run Migrations
        env:
          FLY_ORG: ${{ vars.FLY_ORG }}
          FLY_MIGRATIONS_APP_NAME: ${{ secrets.FLY_MIGRATIONS_APP_NAME }}
          REGISTRY_DB_CONNECTION_STRING: ${{ secrets.REGISTRY_DB_CONNECTION_STRING }}
        run: |
          set -euo pipefail

          APP_NAME="${FLY_MIGRATIONS_APP_NAME}"
          REGION="ams"

          echo "=== Capturing current timestamp for filtering logs ==="
          DEPLOY_TS=$(date -u +"%Y-%m-%dT%H:%M:%S")
          echo "Deployment timestamp: $DEPLOY_TS"

          echo "=== Deploying Migrations Container ==="
          flyctl deploy \
            --config infrastructure/fly/migrations.toml \
            --dockerfile src/BDP.Registry.Migrations/Dockerfile \
            --app "$APP_NAME" \
            --remote-only \
            --env ConnectionStrings__RegistryDatabase="${REGISTRY_DB_CONNECTION_STRING}" \
            --detach

          echo "=== Waiting a few seconds for logs to appear ==="
          sleep 5

          echo "=== Fetching and filtering logs since deployment ==="
          logs=$(flyctl logs --app "$APP_NAME" --region "$REGION" --no-tail)
          filtered_logs=$(echo "$logs" | awk -v ts="$DEPLOY_TS" '{ if ($1 >= ts) print $0 }')

          echo "=== Filtered Logs ==="
          echo "$filtered_logs"

          if echo "$filtered_logs" | grep -iqE "error|exception"; then
            echo "❌ Migrations failed, aborting workflow."
            exit 1
          fi

          echo "✅ Migrations completed successfully."

  deploy-api:
    name: Deploy API
    needs: [check-trigger, deploy-migrations]
    if: |
      always() &&
      needs.check-trigger.outputs.should_deploy == 'true' &&
      needs.check-trigger.outputs.deploy_api == 'true' &&
      (needs.deploy-migrations.result == 'success' || needs.deploy-migrations.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy API
        env:
          FLY_APP_NAME: ${{ secrets.FLY_API_APP_NAME }}
          REGISTRY_DB_CONNECTION_STRING: ${{ secrets.REGISTRY_DB_CONNECTION_STRING }}
        run: |
          flyctl deploy \
            --config infrastructure/fly/api.toml \
            --dockerfile src/BDP.Registry.API/Dockerfile \
            --app "${FLY_APP_NAME}" \
            --remote-only \
            --env ConnectionStrings__RegistryDatabase="${REGISTRY_DB_CONNECTION_STRING}"

  deploy-jobs:
    name: Deploy Jobs
    needs: [check-trigger, deploy-migrations]
    if: |
      always() &&
      needs.check-trigger.outputs.should_deploy == 'true' &&
      needs.check-trigger.outputs.deploy_jobs == 'true' &&
      (needs.deploy-migrations.result == 'success' || needs.deploy-migrations.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Jobs
        env:
          FLY_APP_NAME: ${{ secrets.FLY_JOBS_APP_NAME }}
          REGISTRY_DB_CONNECTION_STRING: ${{ secrets.REGISTRY_DB_CONNECTION_STRING }}
          HANGFIRE_DB_CONNECTION_STRING: ${{ secrets.HANGFIRE_DB_CONNECTION_STRING }}
        run: |
          flyctl deploy \
            --config infrastructure/fly/jobs.toml \
            --dockerfile src/BDP.Registry.Jobs/Dockerfile \
            --app "${FLY_APP_NAME}" \
            --remote-only \
            --env ConnectionStrings__RegistryDatabase="${REGISTRY_DB_CONNECTION_STRING}" \
            --env ConnectionStrings__HangfireDatabase="${HANGFIRE_DB_CONNECTION_STRING}"

  deploy-web:
    name: Deploy Web
    needs: [check-trigger, deploy-api]
    if: |
      always() &&
      needs.check-trigger.outputs.should_deploy == 'true' &&
      needs.check-trigger.outputs.deploy_web == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Web
        env:
          FLY_APP_NAME: ${{ secrets.FLY_WEB_APP_NAME }}
          API_URL: ${{ vars.API_URL }}
        run: |
          flyctl deploy \
            --config infrastructure/fly/web.toml \
            --dockerfile src/BDP.Registry.Web/Dockerfile \
            --app "${FLY_APP_NAME}" \
            --remote-only \
            --env ApiUrl="${API_URL}"

  build-cli:
    name: Build Environment CLI
    needs: [check-trigger, deploy-api]
    if: |
      always() &&
      needs.check-trigger.outputs.should_deploy == 'true' &&
      needs.check-trigger.outputs.build_cli == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    strategy:
      matrix:
        runtime: [linux-x64, linux-arm64, osx-x64, osx-arm64, win-x64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish CLI
        env:
          API_URL: ${{ vars.API_URL }}
        run: |
          dotnet publish src/BDP.CLI/BDP.CLI.csproj \
            -c Release \
            -r ${{ matrix.runtime }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:PublishTrimmed=true \
            -p:ApiUrl="${API_URL}" \
            -o ./dist/${{ matrix.runtime }}

      - name: Create archive
        run: |
          cd dist/${{ matrix.runtime }}
          ENV="${{ needs.check-trigger.outputs.environment }}"
          if [[ "${{ matrix.runtime }}" == win-* ]]; then
            zip -r ../../bdp-cli-${ENV}-${{ matrix.runtime }}.zip .
          else
            tar czf ../../bdp-cli-${ENV}-${{ matrix.runtime }}.tar.gz .
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ needs.check-trigger.outputs.environment }}-${{ matrix.runtime }}
          path: bdp-cli-${{ needs.check-trigger.outputs.environment }}-${{ matrix.runtime }}.*
          retention-days: 30

  deployment-summary:
    name: Deployment Summary
    needs: [check-trigger, deploy-migrations, deploy-api, deploy-jobs, deploy-web, build-cli]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Deployment Summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.check-trigger.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DEPLOYMENT_STATUS="✅ Deployment completed successfully"
          if [[ "${{ needs.deploy-migrations.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-api.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-jobs.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-web.result }}" == "failure" ]]; then
            DEPLOYMENT_STATUS="❌ Deployment completed with failures"
          fi

          echo "$DEPLOYMENT_STATUS" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.check-trigger.outputs.build_cli }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## CLI Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "Download environment-specific CLI from Actions artifacts" >> $GITHUB_STEP_SUMMARY
          fi
