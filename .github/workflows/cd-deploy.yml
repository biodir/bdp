name: CD - Deploy

run-name: "Deploy to ${{ github.event.inputs.environment || 'dev' }}"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev
      deploy_migrations:
        description: 'Deploy database migrations'
        required: true
        type: boolean
        default: true
      deploy_api:
        description: 'Deploy API'
        required: true
        type: boolean
        default: true
      deploy_jobs:
        description: 'Deploy Jobs'
        required: true
        type: boolean
        default: true
      deploy_web:
        description: 'Deploy Web'
        required: true
        type: boolean
        default: true
      build_cli:
        description: 'Build environment-specific CLI'
        required: true
        type: boolean
        default: false
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  DOTNET_VERSION: '9.0.x'

jobs:
  check-trigger:
    name: Check Deployment Trigger
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      environment: ${{ steps.check.outputs.environment }}
      deploy_migrations: ${{ steps.check.outputs.deploy_migrations }}
      deploy_api: ${{ steps.check.outputs.deploy_api }}
      deploy_jobs: ${{ steps.check.outputs.deploy_jobs }}
      deploy_web: ${{ steps.check.outputs.deploy_web }}
      build_cli: ${{ steps.check.outputs.build_cli }}
    steps:
      - name: Determine deployment parameters
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual deployment triggered"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "deploy_migrations=${{ github.event.inputs.deploy_migrations }}" >> $GITHUB_OUTPUT
            echo "deploy_api=${{ github.event.inputs.deploy_api }}" >> $GITHUB_OUTPUT
            echo "deploy_jobs=${{ github.event.inputs.deploy_jobs }}" >> $GITHUB_OUTPUT
            echo "deploy_web=${{ github.event.inputs.deploy_web }}" >> $GITHUB_OUTPUT
            echo "build_cli=${{ github.event.inputs.build_cli }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
              echo "Automatic deployment from successful CI on main"
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "environment=dev" >> $GITHUB_OUTPUT
              echo "deploy_migrations=true" >> $GITHUB_OUTPUT
              echo "deploy_api=true" >> $GITHUB_OUTPUT
              echo "deploy_jobs=true" >> $GITHUB_OUTPUT
              echo "deploy_web=true" >> $GITHUB_OUTPUT
              echo "build_cli=false" >> $GITHUB_OUTPUT
            else
              echo "CI workflow did not succeed, skipping deployment"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Unknown trigger, skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy-migrations:
    name: Deploy Database Migrations
    needs: check-trigger
    if: needs.check-trigger.outputs.should_deploy == 'true' && needs.check-trigger.outputs.deploy_migrations == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Run migrations
        env:
          FLY_APP_NAME: ${{ secrets.FLY_MIGRATIONS_APP_NAME }}
        run: |
          flyctl deploy \
            --config infrastructure/fly/migrations.toml \
            --dockerfile src/BDP.Registry.Persistence/Dockerfile.migrations \
            --app "${FLY_APP_NAME}" \
            --remote-only \
            --detach

          echo "## Database Migration Completed" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.check-trigger.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "✅ Migrations deployed successfully" >> $GITHUB_STEP_SUMMARY

  deploy-api:
    name: Deploy API
    needs: [check-trigger, deploy-migrations]
    if: |
      always() &&
      needs.check-trigger.outputs.should_deploy == 'true' &&
      needs.check-trigger.outputs.deploy_api == 'true' &&
      (needs.deploy-migrations.result == 'success' || needs.deploy-migrations.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy API
        env:
          FLY_APP_NAME: ${{ secrets.FLY_API_APP_NAME }}
        run: |
          flyctl deploy \
            --config infrastructure/fly/api.toml \
            --dockerfile src/BDP.Registry.API/Dockerfile \
            --app "${FLY_APP_NAME}" \
            --remote-only

          echo "## API Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.check-trigger.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "App: **${FLY_APP_NAME}**" >> $GITHUB_STEP_SUMMARY
          echo "URL: **https://${FLY_APP_NAME}.fly.dev**" >> $GITHUB_STEP_SUMMARY
          echo "✅ API deployed successfully" >> $GITHUB_STEP_SUMMARY

  deploy-jobs:
    name: Deploy Jobs
    needs: [check-trigger, deploy-migrations]
    if: |
      always() &&
      needs.check-trigger.outputs.should_deploy == 'true' &&
      needs.check-trigger.outputs.deploy_jobs == 'true' &&
      (needs.deploy-migrations.result == 'success' || needs.deploy-migrations.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Jobs
        env:
          FLY_APP_NAME: ${{ secrets.FLY_JOBS_APP_NAME }}
        run: |
          flyctl deploy \
            --config infrastructure/fly/jobs.toml \
            --dockerfile src/BDP.Registry.Jobs/Dockerfile \
            --app "${FLY_APP_NAME}" \
            --remote-only

          echo "## Jobs Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.check-trigger.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "App: **${FLY_APP_NAME}**" >> $GITHUB_STEP_SUMMARY
          echo "✅ Jobs deployed successfully" >> $GITHUB_STEP_SUMMARY

  deploy-web:
    name: Deploy Web
    needs: [check-trigger, deploy-api]
    if: |
      always() &&
      needs.check-trigger.outputs.should_deploy == 'true' &&
      needs.check-trigger.outputs.deploy_web == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Web
        env:
          FLY_APP_NAME: ${{ secrets.FLY_WEB_APP_NAME }}
        run: |
          flyctl deploy \
            --config infrastructure/fly/web.toml \
            --dockerfile src/BDP.Registry.Web/Dockerfile \
            --app "${FLY_APP_NAME}" \
            --remote-only

          echo "## Web Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.check-trigger.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "App: **${FLY_APP_NAME}**" >> $GITHUB_STEP_SUMMARY
          echo "URL: **https://${FLY_APP_NAME}.fly.dev**" >> $GITHUB_STEP_SUMMARY
          echo "✅ Web deployed successfully" >> $GITHUB_STEP_SUMMARY

  build-cli:
    name: Build Environment CLI
    needs: [check-trigger, deploy-api]
    if: |
      always() &&
      needs.check-trigger.outputs.should_deploy == 'true' &&
      needs.check-trigger.outputs.build_cli == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.check-trigger.outputs.environment }}
    strategy:
      matrix:
        runtime: [linux-x64, linux-arm64, osx-x64, osx-arm64, win-x64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get API URL
        id: api-url
        run: |
          ENV="${{ needs.check-trigger.outputs.environment }}"
          if [ "$ENV" == "prod" ]; then
            API_URL="${{ vars.PROD_API_URL || 'https://bdp-registry-api-prod.fly.dev' }}"
          elif [ "$ENV" == "staging" ]; then
            API_URL="${{ vars.STAGING_API_URL || 'https://bdp-registry-api-staging.fly.dev' }}"
          else
            API_URL="${{ vars.DEV_API_URL || 'https://bdp-registry-api-dev.fly.dev' }}"
          fi
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Publish CLI
        run: |
          dotnet publish src/BDP.CLI/BDP.CLI.csproj \
            -c Release \
            -r ${{ matrix.runtime }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:PublishTrimmed=true \
            -p:ApiUrl="${{ steps.api-url.outputs.api_url }}" \
            -o ./dist/${{ matrix.runtime }}

      - name: Create archive
        run: |
          cd dist/${{ matrix.runtime }}
          ENV="${{ needs.check-trigger.outputs.environment }}"
          if [[ "${{ matrix.runtime }}" == win-* ]]; then
            zip -r ../../bdp-cli-${ENV}-${{ matrix.runtime }}.zip .
          else
            tar czf ../../bdp-cli-${ENV}-${{ matrix.runtime }}.tar.gz .
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ needs.check-trigger.outputs.environment }}-${{ matrix.runtime }}
          path: bdp-cli-${{ needs.check-trigger.outputs.environment }}-${{ matrix.runtime }}.*
          retention-days: 30

  deployment-summary:
    name: Deployment Summary
    needs: [check-trigger, deploy-migrations, deploy-api, deploy-jobs, deploy-web, build-cli]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.check-trigger.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Component Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          check_component() {
            local result=$1
            local name=$2
            local requested=$3

            if [[ "$requested" == "true" ]]; then
              if [[ "$result" == "success" ]]; then
                echo "✅ $name: Deployed successfully" >> $GITHUB_STEP_SUMMARY
              elif [[ "$result" == "failure" ]]; then
                echo "❌ $name: Deployment failed" >> $GITHUB_STEP_SUMMARY
              elif [[ "$result" == "cancelled" ]]; then
                echo "⏹️ $name: Deployment cancelled" >> $GITHUB_STEP_SUMMARY
              else
                echo "⏭️ $name: Skipped" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "⏭️ $name: Not requested" >> $GITHUB_STEP_SUMMARY
            fi
          }

          check_component "${{ needs.deploy-migrations.result }}" "Database Migrations" "${{ needs.check-trigger.outputs.deploy_migrations }}"
          check_component "${{ needs.deploy-api.result }}" "API" "${{ needs.check-trigger.outputs.deploy_api }}"
          check_component "${{ needs.deploy-jobs.result }}" "Jobs" "${{ needs.check-trigger.outputs.deploy_jobs }}"
          check_component "${{ needs.deploy-web.result }}" "Web" "${{ needs.check-trigger.outputs.deploy_web }}"
          check_component "${{ needs.build-cli.result }}" "CLI Build" "${{ needs.check-trigger.outputs.build_cli }}"

          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=false
          if [[ "${{ needs.deploy-migrations.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-api.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-jobs.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-web.result }}" == "failure" ]]; then
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            echo "❌ Deployment completed with failures" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ Deployment completed successfully" >> $GITHUB_STEP_SUMMARY

            if [[ "${{ needs.check-trigger.outputs.build_cli }}" == "true" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## CLI Artifacts" >> $GITHUB_STEP_SUMMARY
              echo "Download environment-specific CLI from Actions artifacts" >> $GITHUB_STEP_SUMMARY
            fi
          fi
